<div class="exams-container">
  <div class="header">
    <h1>Manage Exams</h1>
    <div class="header-actions">
      <div class="search-container" *ngIf="!showCreateForm && exams.length > 0">
        <input type="text" placeholder="Rechercher un examen..." class="search-input" (input)="searchExams($event)">
        <i class="fas fa-search search-icon"></i>
      </div>
      <button class="create-btn" (click)="toggleCreateForm()" *ngIf="!showCreateForm">
        <i class="fas fa-plus"></i> Create New Exam
      </button>
    </div>
  </div>

  <div class="alert alert-danger" *ngIf="error">
    {{ error }}
    <button class="close-btn" (click)="error = null">×</button>
  </div>

  <!-- Create/Edit Exam Form -->
  <div class="exam-form-container" *ngIf="showCreateForm">
    <div class="card">
      <div class="card-header">
        <h2>{{ isEditing ? 'Edit Exam' : 'Create New Exam' }}</h2>
        <button class="close-btn" (click)="toggleCreateForm()">×</button>
      </div>
      <div class="card-body">
        <form [formGroup]="examForm" (ngSubmit)="isEditing ? updateExam() : submitExam()">
          <div class="form-group">
            <label for="title">Title*</label>
            <input type="text" id="title" formControlName="title" class="form-control" placeholder="Enter exam title">
            <div class="error-message" *ngIf="examForm.get('title')?.invalid && examForm.get('title')?.touched">
              Title is required and must be at least 3 characters long.
            </div>
          </div>

          <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" formControlName="description" class="form-control" placeholder="Enter exam description" rows="3"></textarea>
          </div>

          <div class="form-group">
            <label for="status">Status</label>
            <select id="status" formControlName="status" class="form-control">
              <option value="draft">Draft</option>
              <option value="published">Published</option>
              <option value="closed">Closed</option>
            </select>
          </div>

          <div class="form-group">
            <label for="deadline">Deadline</label>
            <input type="datetime-local" id="deadline" formControlName="deadline" class="form-control">
          </div>

          <div class="form-group" *ngIf="!isEditing">
            <label for="file">Exam File* (PDF only)</label>
            <input type="file" id="file" (change)="onFileSelected($event)" class="form-control" accept=".pdf">
            <div class="file-name" *ngIf="selectedFile">{{ selectedFile.name }}</div>
            <div class="error-message" *ngIf="!selectedFile && examForm.touched">Please select a PDF file.</div>
          </div>

          <div class="form-actions">
            <button type="button" class="cancel-btn" (click)="toggleCreateForm()">Cancel</button>
            <button type="submit" class="submit-btn" [disabled]="examForm.invalid || ((!selectedFile && !isEditing) || loading)">
              {{ isEditing ? 'Update' : 'Create' }} Exam
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Exams List -->
  <div class="exams-list" *ngIf="!showCreateForm">
    <div class="loading-spinner" *ngIf="loading"></div>

    <div class="no-exams" *ngIf="exams.length === 0 && !loading">
      <p>You haven't created any exams yet.</p>
      <button class="create-btn" (click)="toggleCreateForm()">
        <i class="fas fa-plus"></i> Create Your First Exam
      </button>
    </div>

    <div class="exams-table-container" *ngIf="exams.length > 0 && !loading">
      <table class="exams-table">
        <thead>
          <tr>
            <th (click)="toggleSort('title')" class="sortable">
              Title <i class="fas" [ngClass]="getSortIcon('title')"></i>
            </th>
            <th (click)="toggleSort('status')" class="sortable">
              Status <i class="fas" [ngClass]="getSortIcon('status')"></i>
            </th>
            <th (click)="toggleSort('deadline')" class="sortable">
              Deadline <i class="fas" [ngClass]="getSortIcon('deadline')"></i>
            </th>
            <th (click)="toggleSort('submissionsCount')" class="sortable">
              Submissions <i class="fas" [ngClass]="getSortIcon('submissionsCount')"></i>
            </th>
            <th (click)="toggleSort('createdAt')" class="sortable">
              Created <i class="fas" [ngClass]="getSortIcon('createdAt')"></i>
            </th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let exam of filteredExams" (click)="viewExamDetails(exam)" class="exam-row">
            <td class="title-cell">{{ exam.title }}</td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(exam.status)">
                {{ exam.status }}
              </span>
            </td>
            <td>{{ formatDate(exam.deadline) }}</td>
            <td>{{ exam.submissionsCount || 0 }}</td>
            <td>{{ exam.createdAt | date:'short' }}</td>
            <td class="actions" (click)="$event.stopPropagation()">
              <button class="action-btn edit" (click)="editExam(exam)" title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              
              <div class="status-actions">
                <button class="action-btn publish" *ngIf="exam.status === 'draft'" 
                  (click)="changeStatus(exam, 'published')" title="Publish">
                  <i class="fas fa-check-circle"></i>
                </button>
                
                <button class="action-btn close" *ngIf="exam.status === 'published'" 
                  (click)="changeStatus(exam, 'closed')" title="Close">
                  <i class="fas fa-lock"></i>
                </button>
                
                <button class="action-btn reopen" *ngIf="exam.status === 'closed'" 
                  (click)="changeStatus(exam, 'published')" title="Reopen">
                  <i class="fas fa-lock-open"></i>
                </button>
              </div>
              
              <button class="action-btn template" (click)="uploadCorrectionTemplate(exam)" title="Upload Correction Template">
                <i class="fas fa-file-upload"></i>
              </button>
              
              <button class="action-btn delete" (click)="deleteExam(exam)" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>